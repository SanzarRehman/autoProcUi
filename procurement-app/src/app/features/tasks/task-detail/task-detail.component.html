<div class="task-detail-container">
  <!-- Loading Indicator -->
  <app-loading-spinner 
    *ngIf="loading" 
    message="Loading task details...">
  </app-loading-spinner>

  <!-- Error Message -->
  <div *ngIf="error && !loading" class="error-container">
    <p class="error-message">{{ error }}</p>
    <button class="btn btn-primary" (click)="refreshTaskDetails()">Retry</button>
  </div>

  <!-- Task Details -->
  <div *ngIf="!loading && !error && taskActions" class="task-content">
    <!-- Task Information Card -->
    <div class="task-info-card">
      <div class="card-header">
        <h2>{{ taskActions.label }}</h2>
        <div class="header-actions">
          <!-- RRF Buttons (if ref is a PO number) -->
          <button 
            *ngIf="ref && ref.startsWith('PO-')" 
            class="btn btn-secondary"
            (click)="viewRRF()">
            <mat-icon>visibility</mat-icon>
            View RRF
          </button>
          
          <button 
            *ngIf="ref && ref.startsWith('PO-')" 
            class="btn btn-secondary"
            (click)="downloadRRF()">
            <mat-icon>download</mat-icon>
            Download RRF
          </button>
          
          <!-- Claim Button -->
          <button 
            *ngIf="taskActions.claimable" 
            class="btn btn-success"
            [disabled]="performingAction"
            (click)="onClaimTask()">
            {{ performingAction ? 'Processing...' : 'Claim Task' }}
          </button>
          
          <!-- Release Button -->
          <button 
            *ngIf="taskActions.releasable" 
            class="btn btn-warning"
            [disabled]="performingAction"
            (click)="onReleaseTask()">
            {{ performingAction ? 'Processing...' : 'Release Task' }}
          </button>
          
          <!-- Edit Button -->
          <button 
            *ngIf="isEditable()" 
            class="btn btn-info"
            [disabled]="performingAction"
            (click)="onEditTask()">
            Edit
          </button>
        </div>
      </div>
      
      <div class="task-info-grid">
        <div class="info-item">
          <span class="info-label">Module:</span>
          <span class="info-value">{{ module }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Key:</span>
          <span class="info-value">{{ key }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Reference:</span>
          <span class="info-value">{{ ref }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Assignee:</span>
          <span class="info-value">{{ taskActions.assignee }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Step:</span>
          <span class="info-value">{{ taskActions.name }}</span>
        </div>
      </div>
    </div>

    <!-- Procurement Order Details -->
    <div class="procurement-order-card" *ngIf="procurementOrder">
      <h3>Procurement Order Details</h3>
      <div class="order-details-grid">
        <div class="detail-item">
          <span class="detail-label">PO Number:</span>
          <span class="detail-value po-number">{{ procurementOrder.poNumber }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Item Name:</span>
          <span class="detail-value">{{ procurementOrder.itemName }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Item Type:</span>
          <span class="detail-value">{{ procurementOrder.itemType }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Quantity:</span>
          <span class="detail-value">{{ procurementOrder.quantity }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Amount:</span>
          <span class="detail-value amount">${{ procurementOrder.amount.toFixed(2) }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Status:</span>
          <span class="detail-value">
            <span class="status-badge" [class]="'status-' + procurementOrder.status.toLowerCase()">
              {{ procurementOrder.status }}
            </span>
          </span>
        </div>
        <div class="detail-item full-width">
          <span class="detail-label">Requester:</span>
          <span class="detail-value">{{ procurementOrder.requesterEmail }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Requester Role:</span>
          <span class="detail-value">{{ procurementOrder.requesterRole }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Created At:</span>
          <span class="detail-value">{{ formatDate(procurementOrder.createdAt) }}</span>
        </div>
      </div>
    </div>

    <!-- Dynamic Action Buttons Section (if any) -->
    <div class="actions-section" *ngIf="taskActions.actions && taskActions.actions.length > 0">
      <h3>Workflow Actions</h3>
      <div class="action-buttons">
        <!-- Dynamic Action Buttons from API -->
        <button 
          *ngFor="let action of taskActions.actions"
          [class]="action.css"
          [disabled]="performingAction"
          (click)="onActionClick(action)">
          {{ performingAction ? 'Processing...' : action.label }}
        </button>
      </div>
    </div>

    <!-- Process Diagram Section -->
    <div class="diagram-section" *ngIf="processDiagramUrl">
      <h3>Process Diagram</h3>
      <div class="diagram-container">
        <img [src]="processDiagramUrl" alt="Process Diagram" class="process-diagram" />
      </div>
    </div>

    <!-- History Timeline Section -->
    <div class="history-section">
      <h3>Task History</h3>
      <div class="history-timeline">
        <div *ngIf="taskHistory.length === 0" class="no-history">
          No history available for this task.
        </div>
        
        <div *ngFor="let entry of taskHistory; let last = last" class="timeline-entry">
          <div class="timeline-marker"></div>
          <div class="timeline-content" [class.last-entry]="last">
            <div class="timeline-header">
              <h4 class="step-name">{{ entry.stepName }}</h4>
              <span *ngIf="entry.actionLabel" class="action-label">{{ entry.actionLabel }}</span>
            </div>
            
            <div class="timeline-details">
              <div class="detail-item">
                <span class="detail-label">Assignee:</span>
                <span class="detail-value">{{ entry.assignee }}</span>
              </div>
              
              <div class="detail-item">
                <span class="detail-label">Started:</span>
                <span class="detail-value">{{ formatDate(entry.startAt) }}</span>
              </div>
              
              <div class="detail-item" *ngIf="entry.endAt">
                <span class="detail-label">Ended:</span>
                <span class="detail-value">{{ formatDate(entry.endAt) }}</span>
              </div>
              
              <div class="detail-item" *ngIf="entry.updateBy">
                <span class="detail-label">Updated By:</span>
                <span class="detail-value">{{ entry.updateBy }}</span>
              </div>
            </div>
            
            <div *ngIf="entry.remarks" class="remarks">
              <span class="remarks-label">Remarks:</span>
              <p class="remarks-text">{{ entry.remarks }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- RRF Modal -->
<div class="rrf-modal-overlay" *ngIf="showRRFModal" (click)="closeRRFModal()">
  <div class="rrf-modal-container" (click)="$event.stopPropagation()">
    <div class="rrf-modal-header">
      <h3>Request for Requisition (RRF)</h3>
      <button class="btn-close" (click)="closeRRFModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="rrf-modal-content">
      <div *ngIf="loadingRRF" class="loading-rrf">
        <div class="spinner"></div>
        <p>Loading RRF...</p>
      </div>
      <div *ngIf="!loadingRRF && rrfContent" [innerHTML]="rrfContent" class="rrf-html-content"></div>
    </div>
  </div>
</div>""
